<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Releases - Mr.FLENs Music Finder</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="glass grid" style="padding:12px 16px;">
      <h1>Releases</h1>
      <div class="row" style="align-items:center;gap:8px;">
        <label for="month-select">Month:</label>
        <select id="month-select"></select>
      </div>
    </header>

    <main class="grid" style="padding:16px;">
      <div id="release-list" class="grid"></div>
    </main>

    <script src="public/sort-tracks.js"></script>
    <script src="public/filter-tracks.js"></script>
    <script type="module">
      const AUDIUS_APP_NAME = "Mr.FLENs Music Finder";
      const AUDIUS_API_KEY = "922e6edcae9856000bf6814a1ee5745bfb57734";
      const MRFLEN_AUDIUS_HANDLE = "Mr.FLEN";

      async function pickHost() {
        const res = await fetch("https://api.audius.co");
        const { data } = await res.json();
        return data[Math.floor(Math.random() * data.length)];
      }

      async function fetchUserId(handle) {
        const host = await pickHost();
        const url = `${host}/v1/users/handle/${encodeURIComponent(handle)}?app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
        const res = await fetch(url, { headers: { Accept: "application/json" } });
        const json = await res.json();
        return json.data && json.data.id;
      }

      async function fetchUserTracks(handle) {
        const userId = await fetchUserId(handle);
        if (!userId) return [];
        const host = await pickHost();
        const url = `${host}/v1/users/${userId}/tracks?limit=200&app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
        const res = await fetch(url, { headers: { Accept: "application/json" } });
        const json = await res.json();
        return json.data || [];
      }

      function normalizeAudiusTrack(t) {
        return {
          platform: "audius",
          id: t.id,
          title: t.title,
          artwork: (t.artwork && (t.artwork["150x150"] || t.artwork["480x480"])) || "",
          user: { handle: t.user && t.user.handle ? t.user.handle : "" },
          plays: t.play_count || 0,
          likes: t.favorite_count || 0,
          genre: t.genre || "",
          createdAt: t.release_date || t.created_at || "",
        };
      }

      function renderTracksList(list) {
        return list
          .map(
            (t) => `
      <div class="glass track-card" style="grid-template-columns:72px 1fr auto;">
        <img src="${t.artwork}" width="72" height="72" loading="lazy" alt="artwork" />
        <div>
          <div style="font-weight:700">${t.title || ""}</div>
          <div style="opacity:.7">@${t.user.handle}</div>
        </div>
        <a href="track.html?platform=${t.platform}&id=${t.id}" class="btn">Go To Track</a>
      </div>`
          )
          .join("");
      }

      const monthSelect = document.getElementById("month-select");
      const releaseList = document.getElementById("release-list");
      const params = new URLSearchParams(window.location.search);
      const selectedMonth = params.get("month") || "";

      const userTracksRaw = await fetchUserTracks(MRFLEN_AUDIUS_HANDLE);
      const userTracks = userTracksRaw.map(normalizeAudiusTrack);
      const months = window.listMonths(userTracks);
      months.forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        monthSelect.appendChild(opt);
      });
      const month = selectedMonth || months[months.length - 1] || "";
      if (month) monthSelect.value = month;
      function render(monthVal) {
        let tracks = window.filterByMonth(userTracks, monthVal);
        tracks = window.sortTracks(tracks, "latest");
        releaseList.innerHTML = renderTracksList(tracks);
      }
      monthSelect.addEventListener("change", (e) => {
        const m = e.target.value;
        if (m) window.location.search = `month=${m}`;
      });
      render(month);
    </script>
  </body>
</html>

