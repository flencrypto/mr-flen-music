<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mr.FLENs Music Finder â€” Audius Library</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="glass grid" style="padding:12px 16px;">
    <h1>ðŸŽ¶ Mr.FLENs Music Finder</h1>
    <input id="search" placeholder="Search Audius (Ctrl/âŒ˜-K)" autocomplete="off" />
  </header>

  <main id="results" class="grid" style="padding:16px;"></main>

  <footer class="glass" style="position:sticky;bottom:0;padding:8px;">
    <audio id="player" controls preload="none" style="width:100%"></audio>
  </footer>

<script type="module">
/**
 * Audius REST integration for Mr.FLENs Music Finder.
 *
 * This script uses the public Audius API to search tracks and
 * obtain stream URLs. It debounces search input and updates
 * the result grid dynamically. To customise the look and feel,
 * edit the CSS in style.css.
 */

const AUDIUS_APP_NAME = "Mr.FLENs Music Finder";
const AUDIUS_API_KEY  = "922e6edcae9856000bf6814a1ee5745bfb57734"; // public, read-only (ok in client)
// BACKEND-ONLY (do NOT ship secrets to the browser):
// const AUDIUS_API_SECRET = "YOUR_AUDIUS_API_SECRET";

async function pickHost(){
  const res = await fetch('https://api.audius.co');
  const { data } = await res.json();
  return data[Math.floor(Math.random()*data.length)];
}

async function searchTracks(query){
  const host = await pickHost();
  const url  = `${host}/v1/tracks/search?query=${encodeURIComponent(query)}&app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
  const res  = await fetch(url, { headers: { Accept:'application/json' } });
  const json = await res.json();
  return json.data || [];
}

async function streamUrl(trackId){
  const host = await pickHost();
  return `${host}/v1/tracks/${trackId}/stream?app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
}

// UI wiring
const results = document.querySelector('#results');
const player  = document.querySelector('#player');
const search  = document.querySelector('#search');

let debounceTimer = null;
search.addEventListener('input', async (e)=>{
  const q = e.target.value.trim();
  if (debounceTimer) clearTimeout(debounceTimer);
  debounceTimer = setTimeout(async () => {
    if (!q){ results.innerHTML = ''; return; }
    results.innerHTML = '<div class="glass" style="padding:16px;">Searchingâ€¦</div>';
    try{
      const tracks = await searchTracks(q);
      if(!tracks.length){
        results.innerHTML = '<div class="glass" style="padding:16px;">No results.</div>';
        return;
      }
      results.innerHTML = tracks.map(t => {
        const art = (t.artwork && (t.artwork['150x150'] || t.artwork['480x480'])) || '';
        const handle = t.user && t.user.handle ? t.user.handle : '';
        const plays = t.play_count || 0;
        const likes = t.favorite_count || 0;
        return `
          <div class="glass track-card">
            <img src="${art}" width="72" height="72" loading="lazy" alt="artwork" />
            <div>
              <div style="font-weight:700">${t.title || ''}</div>
              <div style="opacity:.7">@${handle}</div>
              <div style="font-size:12px;opacity:.7">â–¶ ${plays} â™¥ ${likes}</div>
            </div>
            <button data-id="${t.id}" class="play">â–¶</button>
          </div>`;
      }).join('');
      results.querySelectorAll('.play').forEach(btn=>{
        btn.onclick = async () => {
          const url = await streamUrl(btn.dataset.id);
          player.src = url;
          await player.play();
        };
      });
    }catch(err){
      console.error(err);
      results.innerHTML = '<div class="glass" style="padding:16px;">Error contacting Audius API.</div>';
    }
  }, 250);
});

// âŒ˜/Ctrl-K to focus
document.addEventListener('keydown', (e)=>{
  if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); search.focus(); }
});
</script>
</body>
</html>
