<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mr.FLENs Music Finder ‚Äî Audius Library</title>
    <link
      rel="icon"
      href="https://audius-content-6.cultur3stake.com/content/01K0PYMD8X6ZA6JNCDWMWD4510/480x480.jpg"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <script>
      window.GOOGLE_CLIENT_ID = window.GOOGLE_CLIENT_ID || '';
    </script>
      <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;700&display=swap"
        rel="stylesheet"
      />
    <style>
      :root {
        /* Dark, futuristic palette inspired by the new dashboard mockup */
        --color-primary: #2f81f7;
        --color-secondary: #1f6feb;
        --color-bg: #0d1117;
        --color-glass: rgba(32, 38, 50, 0.6);
        --color-text: #f0f6fc;
        --color-muted: #8b949e;
      }
      body {
        background: var(--color-bg);
        color: var(--color-text);
        font-family: "Inter", sans-serif;
        margin: 0;
      }
      header,
      footer,
      main {
        max-width: 1100px;
        margin: auto;
      }
      .glass {
        backdrop-filter: saturate(1.2) blur(12px);
        background: var(--color-glass);
        border: 1px solid #ffffff11;
        border-radius: 16px;
        box-shadow: 0 0 20px #000;
      }
      .grid {
        display: grid;
        gap: 16px;
      }
      input#search {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid #ffffff22;
        background: #1c2333;
        color: var(--color-text);
        outline: none;
      }
      .track-card {
        display: grid;
        grid-template-columns: 72px 1fr auto auto;
        gap: 12px;
        padding: 12px;
        align-items: center;
      }
      .track-card img {
        border-radius: 10px;
      }
      .track-card .btn {
        opacity: 0;
        transition: opacity 0.2s;
      }
      .track-card:hover .btn {
        opacity: 1;
      }
      .btn {
        display: inline-block;
        text-decoration: none;
        border: 1px solid var(--color-primary);
        color: var(--color-text);
        padding: 8px 12px;
        border-radius: 10px;
        background: var(--color-primary);
        cursor: pointer;
      }
      .btn:hover {
        background: var(--color-secondary);
        border-color: var(--color-secondary);
      }
      .playlist-card {
        display: grid;
        grid-template-columns: 72px 1fr;
        gap: 12px;
        padding: 12px;
        align-items: center;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
      }
      .playlist-card img {
        border-radius: 10px;
      }
      .pill {
        padding: 2px 8px;
        border: 1px solid #ffffff22;
        border-radius: 999px;
        font-size: 12px;
        background: var(--color-glass);
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .chip {
        padding: 4px 10px;
        border: 1px solid var(--color-muted);
        border-radius: 20px;
        background: transparent;
        color: var(--color-muted);
        cursor: pointer;
      }
      .chip:hover {
        color: var(--color-secondary);
        border-color: var(--color-secondary);
      }
      .chip.active {
        background: var(--color-primary);
        color: #05060a;
        border-color: var(--color-primary);
      }
      .sort-select {
        padding: 4px 10px;
        border: 1px solid var(--color-muted);
        border-radius: 8px;
        background: var(--color-glass);
        color: var(--color-text);
      }
      #progressContainer {
        display: none;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
      }
      #progressBar {
        flex: 1;
      }
      .carousel {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 4px;
      }
      .featured img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 12px;
      }
      .logo {
        height: 40px;
        width: 40px;
        border-radius: 50%;
        border: 2px solid var(--color-secondary);
        box-shadow: 0 0 4px #000;
      }
      .modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
      }
      .hidden {
        display: none;
      }
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
    <script src="public/theme.js"></script>
  </head>
  <body>
    <div id="fb-root"></div>
    <header class="glass grid" style="padding: 12px 16px; margin: 16px">
      <div
        class="row"
        style="justify-content: space-between; align-items: center"
      >
        <div class="row">
          <img
            src="https://audius-content-6.cultur3stake.com/content/01K0PYMD8X6ZA6JNCDWMWD4510/480x480.jpg"
            alt="Mr.FLEN logo"
            class="logo"
          />
          <h1 style="margin: 0">Mr.FLENs Music Finder</h1>
          <span class="pill">Audius+SC</span>
        </div>
        <button
          id="login"
          class="pill"
          style="cursor: pointer; background: #0000"
        >
          Login
        </button>
        <button id="backup-btn" class="pill" style="cursor:pointer;background:#0000;display:none;">Backup</button>
        <button id="restore-btn" class="pill" style="cursor:pointer;background:#0000;">Restore</button>
        <button id="theme-toggle" class="pill" style="cursor:pointer;background:#0000;">Toggle theme</button>
      </div>
      <nav class="row" style="gap:8px;margin-top:8px" aria-label="Social links">
        <a
          href="https://soundcloud.com/mr-flen"
          class="pill"
          target="_blank"
          rel="noopener"
          >SoundCloud</a
        >
        <a
          href="https://www.tiktok.com/@mr.flen"
          class="pill"
          target="_blank"
          rel="noopener"
          >TikTok</a
        >
        <a
          href="https://www.instagram.com/mr.flen"
          class="pill"
          target="_blank"
          rel="noopener"
          >Instagram</a
        >
        <a
          href="https://twitter.com/themrflen"
          class="pill"
          target="_blank"
          rel="noopener"
          >X</a
        >
      </nav>
      <input
        id="search"
        placeholder="Search tracks (Ctrl/‚åò-K)"
        autocomplete="off"
      />
      <div class="row" style="font-size:14px;gap:4px;align-items:center">
        <input type="checkbox" id="all-artists-toggle" />
        <label for="all-artists-toggle">Include all artists</label>
      </div>
      <div id="genres" class="row"></div>
      <div class="row" style="margin-top:8px;align-items:center;gap:8px;">
        <label for="sort-select">Sort:</label>
        <select id="sort-select" class="sort-select">
          <option value="trending">Trending</option>
          <option value="popular">Most Popular</option>
          <option value="latest">Latest</option>
        </select>
      </div>
    </header>

    <div id="login-modal" class="modal hidden">
      <div class="glass" style="padding:24px;max-width:320px;width:100%;">
        <h2>Sign in</h2>
        <div class="g_id_signin"></div>
        <div id="fb-login-btn" class="btn" style="margin-top:8px;">Login with Facebook</div>
        <div id="insta-login-btn" class="btn" style="margin-top:8px;">Login with Instagram</div>
        <div id="x-login-btn" class="btn" style="margin-top:8px;">Login with X</div>
        <div id="snap-login-btn" class="btn" style="margin-top:8px;">Login with Snapchat</div>
        <div id="tiktok-login-btn" class="btn" style="margin-top:8px;">Login with TikTok</div>
        <div id="close-login" class="btn" style="margin-top:8px;background:transparent;border-color:var(--color-muted);color:var(--color-muted);">Close</div>
      </div>
    </div>

    <main class="grid" style="padding: 0 16px 140px">
      <section id="refengineered-section">
        <h2>ReFLENgineered</h2>
        <div id="refengineered-list" class="grid"></div>
      </section>
      <section id="new-releases-section">
        <h2>New Releases</h2>
        <div class="row" style="align-items:center;gap:8px;">
          <label for="month-select">Browse by month:</label>
          <select id="month-select"></select>
        </div>
        <div id="new-releases-list" class="grid"></div>
      </section>
      <section id="search-section">
        <h2>Search Results</h2>
        <div id="results" class="grid"></div>
      </section>
    </main>

    <footer
      class="glass"
      style="
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 8px;
        margin: 16px;
        display: grid;
        gap: 8px;
      "
    >
        <div class="row" style="justify-content: space-between">
          <span id="queueLabel">Queue: 0</span>
          <div class="row" style="gap: 4px">
            <button id="showQueue" class="btn">üìÉ</button>
            <button id="shuffle" class="btn">üîÄ</button>
            <button id="next" class="btn">‚è≠</button>
          </div>
        </div>
      <div id="playerContainer">
        <div class="row">
          <audio id="player" controls preload="none" style="flex:1"></audio>
          <button id="mute-toggle" class="btn" aria-label="Mute" style="white-space:nowrap;">Mute</button>
        </div>
        <div id="progressContainer" class="row" style="display:none">
          <span id="currentTime">0:00</span>
          <input type="range" id="progressBar" min="0" value="0" />
          <span id="duration">0:00</span>
        </div>
      </div>
      </footer>
      <div
        id="queueModal"
        class="glass"
        style="display:none; position:fixed; right:16px; bottom:120px; width:260px; max-height:60vh; overflow:auto; padding:8px;"
      >
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px;">
          <strong>Up Next</strong>
          <button id="closeQueue" class="btn">‚úñ</button>
        </div>
        <ul id="queueItems" style="list-style:none;padding:0;margin:0;"></ul>
        <button id="savePlaylistBtn" class="btn" style="margin-top:8px;width:100%;">Save Playlist</button>
        <div id="playlistSection" style="margin-top:8px;">
          <strong>Playlists</strong>
          <ul id="playlistList" style="list-style:none;padding:0;margin:4px 0 0 0;"></ul>
        </div>
      </div>
      <script src="format-time.js"></script>
      <script src="public/sort-tracks.js"></script>
      <script src="public/filter-tracks.js"></script>
      <script src="public/drive.js"></script>
      <script src="auth.js"></script>
      <script src="public/queue-utils.js"></script>
      <script src="spotify.js"></script>
      <script type="module">
      /**
       * Audius REST integration for Mr.FLENs Music Finder.
       *
       * This script uses the public Audius API to search tracks and
       * obtain stream URLs. It debounces search input and updates
       * the result grid dynamically. To customise the look and feel,
       * edit the CSS in the <style> block above.
       */

      if (typeof process === "undefined") {
        window.process = { env: {} };
      }
      const env =
        typeof process !== "undefined" && process.env ? process.env : {};
      const AUDIUS_APP_NAME = "Mr.FLENs Music Finder";
      const AUDIUS_API_KEY = "922e6edcae9856000bf6814a1ee5745bfb57734"; // public, read-only (ok in client)
      const MRFLEN_AUDIUS_HANDLE = "Mr.FLEN";
      const MRFLEN_SC_USERNAME = "mr-flen";
      const SOUNDCLOUD_CLIENT_ID = "YOUR_SOUNDCLOUD_API_KEY";
      const MRFLEN_SPOTIFY_ID = env.MRFLEN_SPOTIFY_ID || "";
      // Theme setup
      const { applyTheme, getSavedTheme, toggleTheme } = window.Theme;
      applyTheme(getSavedTheme());
      document.getElementById("theme-toggle").addEventListener("click", () => {
        toggleTheme();
      });
      // pagination state for infinite scrolling
      let currentQuery = "";
      let currentOffset = 0;
      const PAGE_LIMIT = 20;
      let loadingMore = false;
      let hasMore = false;
      // BACKEND-ONLY (do NOT ship secrets to the browser):
      // const AUDIUS_API_SECRET = "YOUR_AUDIUS_API_SECRET";

      async function pickHost() {
        const res = await fetch("https://api.audius.co");
        const { data } = await res.json();
        return data[Math.floor(Math.random() * data.length)];
      }

      async function searchTracks(query, offset = 0, limit = PAGE_LIMIT) {
        const host = await pickHost();
        const url = `${host}/v1/tracks/search?query=${encodeURIComponent(query)}&limit=${limit}&offset=${offset}&app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
        const res = await fetch(url, {
          headers: { Accept: "application/json" },
        });
        const json = await res.json();
        return json.data || [];
      }

      async function searchSoundCloud(query, offset = 0, limit = PAGE_LIMIT) {
        const url = `https://api.soundcloud.com/tracks?client_id=${SOUNDCLOUD_CLIENT_ID}&q=${encodeURIComponent(query)}&limit=${limit}&offset=${offset}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("sc");
        const json = await res.json();
        return json;
      }

      async function streamUrl(trackId) {
        const host = await pickHost();
        return `${host}/v1/tracks/${trackId}/stream?app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
      }

      async function trendingTracks(genre) {
        const host = await pickHost();
        const genreParam = genre ? `&genre=${encodeURIComponent(genre)}` : "";
        const url = `${host}/v1/tracks/trending?limit=5${genreParam}&app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
        const res = await fetch(url, {
          headers: { Accept: "application/json" },
        });
        const json = await res.json();
        return (json.data || []).map(normalizeAudiusTrack);
      }

      async function genreTracks(genre, sort) {
        const host = await pickHost();
        const genreParam = genre ? `&genre=${encodeURIComponent(genre)}` : "";
        const sortParam = sort === 'latest' ? 'release_date' : 'plays';
        const url = `${host}/v1/tracks?limit=5${genreParam}&sort=${sortParam}&app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
        const res = await fetch(url, { headers: { Accept: "application/json" } });
        const json = await res.json();
        return (json.data || []).map(normalizeAudiusTrack);
      }

      async function fetchUserId(handle) {
        const host = await pickHost();
        const url = `${host}/v1/users/handle/${encodeURIComponent(handle)}?app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
        const res = await fetch(url, { headers: { Accept: 'application/json' } });
        const json = await res.json();
        return json.data && json.data.id;
      }

      async function fetchUserTracks(handle) {
        const userId = await fetchUserId(handle);
        if (!userId) return [];
        const host = await pickHost();
        const url = `${host}/v1/users/${userId}/tracks?limit=200&app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
        const res = await fetch(url, { headers: { Accept: 'application/json' } });
        const json = await res.json();
        return json.data || [];
      }

      async function trendingPlaylists() {
        const host = await pickHost();
        const url = `${host}/v1/playlists/trending?limit=5&app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
        const res = await fetch(url, {
          headers: { Accept: "application/json" },
        });
        const json = await res.json();
        return json.data || [];
      }

      async function latestRelease() {
        const tracks = await searchTracks(MRFLEN_AUDIUS_HANDLE);
        return tracks[0] ? normalizeAudiusTrack(tracks[0]) : null;

        async function fetchPlaylist(id) {
          const host = await pickHost();
          const url = `${host}/v1/playlists/${id}?app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
          const res = await fetch(url, {
            headers: { Accept: "application/json" },
          });
          const json = await res.json();
          return json.data || null;
        }
      }

      function renderFeatured(track) {
        if (!track) return "";
        return `
    <a href="track.html?platform=${track.platform}&id=${track.id}" class="glass featured" style="display:block;text-decoration:none;color:inherit">
      <img src="${track.artwork}" alt="artwork" />
      <div style="padding:16px">
        <div style="font-weight:700">${track.title || ""}</div>
        <div style="opacity:.7">@${track.user.handle}</div>
      </div>
    </a>`;
      }

      function normalizeAudiusTrack(t) {
        return {
          platform: "audius",
          id: t.id,
          title: t.title,
          artwork:
            (t.artwork && (t.artwork["150x150"] || t.artwork["480x480"])) || "",
          user: { handle: t.user && t.user.handle ? t.user.handle : "" },
          plays: t.play_count || 0,
          likes: t.favorite_count || 0,
          genre: t.genre || '',
          createdAt: t.release_date || t.created_at || '',
        };
      }

      function normalizeSoundCloudTrack(t) {
        return {
          platform: "soundcloud",
          id: t.id,
          title: t.title,
          artwork: t.artwork_url || "",
          permalink_url: t.permalink_url,
          user: { handle: t.user && t.user.username ? t.user.username : "" },
          plays: t.playback_count || 0,
          likes: t.likes_count || t.favoritings_count || 0,
          genre: t.genre || '',
          createdAt: t.created_at || '',
        };
      }

      const LIKED_KEY = 'likedTracks';
      const PLAYLIST_KEY = 'customPlaylists';
      const SEARCH_ALL_KEY = 'searchAllArtists';

      let likedTracks = [];
      let customPlaylists = [];
      let searchAllArtists = false;
      try {
        searchAllArtists =
          localStorage.getItem(SEARCH_ALL_KEY) === 'true';
      } catch {}

      function loadPreferences() {
        try {
          return {
            liked: JSON.parse(localStorage.getItem(LIKED_KEY)) || [],
            playlists: JSON.parse(localStorage.getItem(PLAYLIST_KEY)) || [],
          };
        } catch {
          return { liked: [], playlists: [] };
        }
      }

      function savePreferences() {
        try {
          localStorage.setItem(LIKED_KEY, JSON.stringify(likedTracks));
          localStorage.setItem(
            PLAYLIST_KEY,
            JSON.stringify(customPlaylists)
          );
        } catch {
          // Ignore storage write errors
        }
      }

      function isLiked(track) {
        return likedTracks.some(
          (t) => t.id === track.id && t.platform === track.platform
        );
      }

      function toggleLike(track) {
        if (isLiked(track)) {
          likedTracks = likedTracks.filter(
            (t) => !(t.id === track.id && t.platform === track.platform)
          );
        } else {
          likedTracks.push(track);
        }
        savePreferences();
      }

      function savePlaylist(pl) {
        const idx = customPlaylists.findIndex((p) => p.name === pl.name);
        if (idx > -1) customPlaylists[idx] = pl;
        else customPlaylists.push(pl);
        savePreferences();
      }

      ({ liked: likedTracks, playlists: customPlaylists } = loadPreferences());

      /** UI wiring **/

      const results = document.querySelector("#results");
      const refengineeredList = document.querySelector("#refengineered-list");
      const newReleasesList = document.querySelector("#new-releases-list");
      const monthSelect = document.getElementById("month-select");
      let audioPlayer = document.querySelector("#player");
      const muteBtn = document.getElementById("mute-toggle");
      const search = document.querySelector("#search");
      const allArtistsToggle = document.querySelector("#all-artists-toggle");
      const login = document.querySelector("#login");
      const loginModal = document.querySelector("#login-modal");
      const fbLoginBtn = document.querySelector("#fb-login-btn");
      const instaLoginBtn = document.querySelector("#insta-login-btn");
      const xLoginBtn = document.querySelector("#x-login-btn");
      const snapLoginBtn = document.querySelector("#snap-login-btn");
      const tiktokLoginBtn = document.querySelector("#tiktok-login-btn");
      const closeLogin = document.querySelector("#close-login");
      (function initGoogle() {
        if (!initGoogleAuth()) setTimeout(initGoogle, 100);
      })();
        const nextBtn = document.querySelector("#next");
        const shuffleBtn = document.querySelector("#shuffle");
        const queueLabel = document.querySelector("#queueLabel");
        const showQueueBtn = document.getElementById("showQueue");
        const queueModal = document.getElementById("queueModal");
        const queueItems = document.getElementById("queueItems");
        const closeQueueBtn = document.getElementById("closeQueue");
        const savePlaylistBtn = document.getElementById("savePlaylistBtn");
        const playlistList = document.getElementById("playlistList");
        const genresEl = document.querySelector("#genres");
        const { addToQueue, removeFromQueue, moveInQueue, adjustIndexOnRemove } =
          queueUtils;
      let progressContainer;
      let progressBar;
      let currentTimeEl;
      let durationEl;

      function updateMuteButton() {
        if (!audioPlayer) return;
        muteBtn.textContent = audioPlayer.muted ? "Unmute" : "Mute";
      }

      muteBtn.addEventListener("click", () => {
        if (!audioPlayer) return;
        audioPlayer.muted = !audioPlayer.muted;
        updateMuteButton();
      });

      document.addEventListener("keydown", (e) => {
        if (["INPUT", "TEXTAREA"].includes(e.target.tagName)) return;
        if (!audioPlayer) return;
        if (e.code === "Space") {
          e.preventDefault();
          if (audioPlayer.paused) {
            audioPlayer.play();
          } else {
            audioPlayer.pause();
          }
        }
        if (e.key === "m" || e.key === "M") {
          audioPlayer.muted = !audioPlayer.muted;
          updateMuteButton();
        }
      });

      function cacheProgressEls() {
        progressContainer = document.getElementById("progressContainer");
        progressBar = document.getElementById("progressBar");
        currentTimeEl = document.getElementById("currentTime");
        durationEl = document.getElementById("duration");
      }

      cacheProgressEls();

      function attachPlayer(player) {
        audioPlayer = player;
        if (!player) {
          if (progressContainer) progressContainer.style.display = "none";
          return;
        }
        progressContainer.style.display = "flex";
        progressBar.value = 0;
        currentTimeEl.textContent = "0:00";
        durationEl.textContent = "0:00";
        player.addEventListener("timeupdate", () => {
          progressBar.value = player.currentTime;
          currentTimeEl.textContent = formatTime(player.currentTime);
        });
        player.addEventListener("loadedmetadata", () => {
          progressBar.max = player.duration;
          durationEl.textContent = formatTime(player.duration);
        });
        progressBar.oninput = (e) => {
          player.currentTime = e.target.value;
        };
        updateMuteButton();
      }

      attachPlayer(null);

      allArtistsToggle.checked = searchAllArtists;
      allArtistsToggle.addEventListener("change", () => {
        searchAllArtists = allArtistsToggle.checked;
        try {
          localStorage.setItem(SEARCH_ALL_KEY, searchAllArtists);
        } catch {}
        if (search.value.trim()) search.dispatchEvent(new Event("input"));
      });

        const { handleAuthSuccess, exchangeCodeForToken } = window;
        const GENRES = ["All", "UKG", "Grime", "House", "Deep House", "DNB"];
        let currentGenre = null;
        let currentSort = 'trending';
        if (window.location.hash.includes("access_token")) {
          const params = new URLSearchParams(window.location.hash.substring(1));
          const token = params.get("access_token");
          const provider = params.get("state");
          if (token && provider) handleAuthSuccess(provider, token);
          window.location.hash = "";
        } else {
          const params = new URLSearchParams(window.location.search);
          const code = params.get("code");
          const provider = params.get("state");
          if (code && provider) {
            exchangeCodeForToken(provider, code)
              .then((tok) => handleAuthSuccess(provider, tok))
              .catch((err) => console.error('Auth exchange failed', err))
              .finally(() => {
                const url = new URL(window.location.href);
                url.searchParams.delete('code');
                url.searchParams.delete('state');
                window.history.replaceState({}, '', url.pathname + url.search);
              });
          }
        }
        GENRES.forEach((g) => {
        const chip = document.createElement("button");
        chip.textContent = g;
        chip.className = "chip" + (g === "All" ? " active" : "");
        chip.onclick = () => {
          currentGenre = g === "All" ? null : g;
          Array.from(genresEl.children).forEach((c) =>
            c.classList.remove("active"),
          );
          chip.classList.add("active");
          loadHome(currentGenre);
        };
        genresEl.appendChild(chip);
      });
      const sortSelect = document.getElementById('sort-select');
      sortSelect.addEventListener('change', () => {
        currentSort = sortSelect.value;
        if (currentQuery) {
          performSearch(currentQuery);
        } else {
          loadHome(currentGenre);
        }
      });

        const trackCache = {};
        let queue = [];
        let currentIndex = -1;

        function renderQueue() {
          queueItems.innerHTML = queue
            .map(
              (t, i) =>
                `<li class="row" data-idx="${i}" style="justify-content:space-between;align-items:center;margin-bottom:4px;">
                  <span style="flex:1">${t.title || ''}</span>
                  <div class="row" style="gap:4px;">
                    <button class="btn up" data-idx="${i}">‚¨ÜÔ∏è</button>
                    <button class="btn down" data-idx="${i}">‚¨áÔ∏è</button>
                    <button class="btn remove" data-idx="${i}">‚úñÔ∏è</button>
                  </div>
                </li>`
            )
            .join('');
        }

        function updateQueue() {
          queueLabel.textContent = `Queue: ${queue.length}`;
          if (queueModal.style.display !== 'none') renderQueue();
        }

        function renderPlaylists() {
          playlistList.innerHTML = customPlaylists
            .map(
              (p, i) =>
                `<li class="row" data-idx="${i}" style="justify-content:space-between;align-items:center;margin-bottom:4px;">
                  <span style="flex:1">${p.name}</span>
                  <div class="row" style="gap:4px;">
                    <button class="btn load" data-idx="${i}">‚ñ∂</button>
                    <button class="btn del" data-idx="${i}">üóë</button>
                  </div>
                </li>`
            )
            .join('');
        }

        showQueueBtn.onclick = () => {
          queueModal.style.display = 'block';
          renderQueue();
          renderPlaylists();
        };
        closeQueueBtn.onclick = () => (queueModal.style.display = 'none');

        queueItems.onclick = (e) => {
          const idx = Number(e.target.dataset.idx);
          if (Number.isNaN(idx)) return;
          if (e.target.classList.contains('remove')) {
            queue = removeFromQueue(queue, idx);
            currentIndex = adjustIndexOnRemove(currentIndex, idx);
            if (currentIndex >= queue.length) currentIndex = queue.length - 1;
            updateQueue();
          } else if (e.target.classList.contains('up')) {
            queue = moveInQueue(queue, idx, idx - 1);
            updateQueue();
          } else if (e.target.classList.contains('down')) {
            queue = moveInQueue(queue, idx, idx + 1);
            updateQueue();
          }
        };

        savePlaylistBtn.onclick = () => {
          if (!queue.length) return;
          const name = prompt('Playlist name?');
          if (!name) return;
          savePlaylist({ name, tracks: queue.slice() });
          renderPlaylists();
        };

        playlistList.onclick = (e) => {
          const idx = Number(e.target.dataset.idx);
          if (Number.isNaN(idx)) return;
          if (e.target.classList.contains('load')) {
            const pl = customPlaylists[idx];
            queue = pl.tracks.slice();
            currentIndex = -1;
            queueModal.style.display = 'none';
            updateQueue();
          } else if (e.target.classList.contains('del')) {
            customPlaylists.splice(idx, 1);
            savePreferences();
            renderPlaylists();
          }
        };

      async function playTrack(track) {
        const container = document.querySelector("#playerContainer");
        if (track.platform === "soundcloud") {
          const res = await fetch(
            `https://soundcloud.com/oembed?format=json&url=${encodeURIComponent(track.permalink_url)}`,
          );
          const { html } = await res.json();
          container.innerHTML = html;
          cacheProgressEls();
          audioPlayer = null;
          attachPlayer(null);
        } else {
          container.innerHTML = `
            <audio id="player" controls preload="none" style="width:100%"></audio>
            <div id="progressContainer" class="row" style="display:none">
              <span id="currentTime">0:00</span>
              <input type="range" id="progressBar" min="0" value="0" />
              <span id="duration">0:00</span>
            </div>`;
          cacheProgressEls();
          audioPlayer = document.querySelector("#player");
          attachPlayer(audioPlayer);
          let url = '';
          if (track.platform === "spotify") {
            url = track.streamUrl;
          } else {
            url = await streamUrl(track.id);
          }
          audioPlayer.src = url;
          await audioPlayer.play();
          audioPlayer.addEventListener("ended", () => nextBtn.onclick(), {
            once: true,
          });
        }
      }

      function renderTracksList(list, includeLink = false) {
        return list
          .map((t) => {
            trackCache[`${t.platform}:${t.id}`] = t;
            const buttons = [
              `<button data-platform="${t.platform}" data-id="${t.id}" class="btn play">‚ñ∂</button>`,
            ];
            if (t.platform !== "soundcloud")
              buttons.push(
                `<button data-platform="${t.platform}" data-id="${t.id}" class="btn queue">‚ûï</button>`,
              );
            buttons.push(
              `<button data-platform="${t.platform}" data-id="${t.id}" class="btn like">${isLiked(t) ? "‚ô•" : "‚ô°"}</button>`,
            );
            if (includeLink)
              buttons.push(
                `<a href="track.html?platform=${t.platform}&id=${t.id}" class="btn">Go To Track</a>`,
              );
            const cols = `72px 1fr${" auto".repeat(buttons.length)}`;
            const badge = `<span class="pill">${
              t.platform === "audius"
                ? "Audius"
                : t.platform === "soundcloud"
                ? "SoundCloud"
                : "Spotify"
            }</span>`;
            return `
      <div class="glass track-card" style="grid-template-columns:${cols};">
        <img src="${t.artwork}" width="72" height="72" loading="lazy" alt="artwork" />
        <div>
          <div style="font-weight:700">${t.title || ""}</div>
          <div style="opacity:.7">@${t.user.handle} ${badge}</div>
          <div style="font-size:12px;opacity:.7">‚ñ∂ ${t.plays} ‚ô• ${t.likes}</div>
        </div>
        ${buttons.join("")}
      </div>`;
          })
          .join("");
      }

      function attachTrackEvents(container = results) {
        container.querySelectorAll(".play").forEach((btn) => {
          btn.onclick = async () => {
            const key = `${btn.dataset.platform}:${btn.dataset.id}`;
            const track = trackCache[key];
            if (track.platform !== "soundcloud") {
              queue = addToQueue(queue, track);
              currentIndex = queue.length - 1;
              updateQueue();
            }
            await playTrack(track);
          };
        });
        container.querySelectorAll(".queue").forEach((btn) => {
          btn.onclick = () => {
            const key = `${btn.dataset.platform}:${btn.dataset.id}`;
            const track = trackCache[key];
            queue = addToQueue(queue, track);
            updateQueue();
          };
        });
        container.querySelectorAll(".like").forEach((btn) => {
          btn.onclick = () => {
            const key = `${btn.dataset.platform}:${btn.dataset.id}`;
            const track = trackCache[key];
            toggleLike(track);
            btn.textContent = isLiked(track) ? "‚ô•" : "‚ô°";
          };
        });
      }

      function renderPlaylistList(list) {
        return list
          .map((p) => {
            const art =
              (p.artwork && (p.artwork["150x150"] || p.artwork["480x480"])) ||
              "";
            return `
      <a class="glass playlist-card" href="playlist.html?id=${p.id}">
        <img src="${art}" width="72" height="72" loading="lazy" alt="artwork" />
        <div>
          <div style="font-weight:700">${p.playlist_name || ""}</div>
          <div style="opacity:.7">${p.track_count || 0} tracks</div>
        </div>
      </a>`;
          })
          .join("");
      }

      async function loadHome(genre) {
        results.innerHTML =
          '<div class="glass" style="padding:16px;">Loading‚Ä¶</div>';
        try {
          const [tracksRaw, playlists, feature] = await Promise.all([
            currentSort === 'trending'
              ? trendingTracks(genre)
              : genreTracks(genre, currentSort),
            trendingPlaylists(),
            latestRelease(),
          ]);
          const tracks =
            currentSort === 'trending'
              ? tracksRaw
              : window.sortTracks(
                  tracksRaw,
                  currentSort === 'latest' ? 'latest' : 'plays',
                );
          const genreLabel = genre ? ` ‚Äî ${genre}` : "";
          const sortLabel =
            currentSort === 'latest'
              ? 'Latest Tracks'
              : currentSort === 'popular'
              ? 'Most Popular Tracks'
              : 'Trending Tracks';
          results.innerHTML = `
      ${renderFeatured(feature)}
      <h2>${sortLabel}${genreLabel}</h2>
      <div class="carousel">${renderTracksList(tracks, true)}</div>
      <h2>Trending Playlists</h2>
      ${renderPlaylistList(playlists)}
    `;
          attachTrackEvents();
        } catch (err) {
          console.error(err);
          results.innerHTML =
            '<div class="glass" style="padding:16px;">Error loading trending data.</div>';
        }
      }

      async function performSearch(q, append = false) {
        if (!q) {
          loadHome(currentGenre);
          return;
        }
        if (!append) {
          currentQuery = q;
          currentOffset = 0;
          results.innerHTML =
            '<div class="glass" style="padding:16px;">Searching‚Ä¶</div>';
        }
        try {
          let scError = false;
          let spError = false;
          const [a, s, p] = await Promise.all([
            searchTracks(q, currentOffset),
            searchSoundCloud(q, currentOffset).catch(() => {
              scError = true;
              return [];
            }),
            searchSpotify(q, currentOffset, PAGE_LIMIT).catch(() => {
              spError = true;
              return [];
            }),
          ]);
          let audiusTracks = a.map(normalizeAudiusTrack);
          let scTracks = s.map(normalizeSoundCloudTrack);
          let spTracks = p.map(normalizeSpotifyTrack);
          if (!searchAllArtists) {
            audiusTracks = audiusTracks.filter(
              (t) => t.user && t.user.handle === MRFLEN_AUDIUS_HANDLE,
            );
            scTracks = scTracks.filter(
              (t) => t.user && t.user.handle === MRFLEN_SC_USERNAME,
            );
            spTracks = spTracks.filter(
              (t) => t.user && t.user.id === MRFLEN_SPOTIFY_ID,
            );
          }
          let tracks = [...audiusTracks, ...scTracks, ...spTracks];
          if (currentGenre) tracks = window.filterByGenre(tracks, currentGenre);
          const sortKey = currentSort === 'latest' ? 'latest' : 'plays';
          tracks = window.sortTracks(tracks, sortKey);
          const scopeMessage = searchAllArtists
            ? 'Showing all artists'
            : 'Showing Mr.FLEN only';
          if (!tracks.length && !append) {
            results.innerHTML =
              `<div class="glass" style="padding:16px;">${scopeMessage}</div>` +
              `<div class="glass" style="padding:16px;margin-top:8px;">No ${
                searchAllArtists ? '' : 'Mr.FLEN '
              }tracks found.</div>`;
            if (scError)
              results.innerHTML +=
                '<div class="glass" style="padding:16px;margin-top:8px;">‚ö†Ô∏è SoundCloud results unavailable.</div>';
            if (spError)
              results.innerHTML +=
                '<div class="glass" style="padding:16px;margin-top:8px;">‚ö†Ô∏è Spotify results unavailable.</div>';
            return;
          }
          if (!append) {
            let html =
              `<div class="glass" style="padding:16px;">${scopeMessage}</div>` +
              renderTracksList(tracks, true);
            if (scError)
              html =
                '<div class="glass" style="padding:16px;">‚ö†Ô∏è SoundCloud results unavailable.</div>' +
                html;
            if (spError)
              html =
                '<div class="glass" style="padding:16px;">‚ö†Ô∏è Spotify results unavailable.</div>' +
                html;
            results.innerHTML = html;
          } else {
            results.innerHTML += renderTracksList(tracks, true);
          }
          attachTrackEvents();
          hasMore =
            a.length === PAGE_LIMIT ||
            s.length === PAGE_LIMIT ||
            p.length === PAGE_LIMIT;
          currentOffset += PAGE_LIMIT;
        } catch (err) {
          console.error(err);
          if (!append)
            results.innerHTML =
              '<div class="glass" style="padding:16px;">Error contacting APIs.</div>';
        }
      }

      window.addEventListener("scroll", async () => {
        if (
          currentQuery &&
          hasMore &&
          !loadingMore &&
          window.innerHeight + window.scrollY >=
            document.body.offsetHeight - 100
        ) {
          loadingMore = true;
          await performSearch(currentQuery, true);
          loadingMore = false;
        }
      });

      let debounceTimer = null;
      search.addEventListener("input", (e) => {
        const q = e.target.value.trim();
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => performSearch(q), 250);
      });

      nextBtn.onclick = () => {
        if (currentIndex + 1 < queue.length) {
          currentIndex++;
          playTrack(queue[currentIndex]);
        }
      };

      login.onclick = () => loginModal.classList.remove("hidden");
      closeLogin.onclick = () => loginModal.classList.add("hidden");
      window.onGoogleSignIn = (res) => {
        handleAuthSuccess("google", res.credential);
      };
      window.fbAsyncInit = function () {
        FB.init({
          appId: "FACEBOOK_APP_ID",
          cookie: true,
          xfbml: true,
          version: "v19.0",
        });
      };
      fbLoginBtn.onclick = () => {
        FB.login(
          (response) => {
            if (response.authResponse) {
              handleAuthSuccess("facebook", response.authResponse.accessToken);
            }
          },
          { scope: "public_profile,email" }
        );
      };
      const buildRedirectUri = () =>
        window.location.origin +
        window.location.pathname +
        window.location.search;
        instaLoginBtn.onclick = () => {
          const clientId = env.INSTAGRAM_CLIENT_ID || "";
          const redirectUri = buildRedirectUri();
        const url = `https://api.instagram.com/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(
          redirectUri
        )}&scope=user_profile&response_type=token&state=instagram`;
        window.location.href = url;
      };
        xLoginBtn.onclick = () => {
          const clientId = env.X_CLIENT_ID || "";
          const redirectUri = buildRedirectUri();
        const url = `https://twitter.com/i/oauth2/authorize?response_type=token&client_id=${clientId}&redirect_uri=${encodeURIComponent(
          redirectUri
        )}&scope=tweet.read%20users.read&state=x`;
        window.location.href = url;
      };
        snapLoginBtn.onclick = () => {
          const clientId = env.SNAPCHAT_CLIENT_ID || "";
          const redirectUri = buildRedirectUri();
        const url = `https://accounts.snapchat.com/accounts/oauth2/auth?response_type=token&client_id=${clientId}&redirect_uri=${encodeURIComponent(
          redirectUri
        )}&scope=snapchat_marketing_api&state=snapchat`;
        window.location.href = url;
      };
        tiktokLoginBtn.onclick = () => {
          const clientId = env.TIKTOK_CLIENT_ID || "";
          const redirectUri = buildRedirectUri();
        const url = `https://www.tiktok.com/auth/authorize?client_key=${clientId}&redirect_uri=${encodeURIComponent(
          redirectUri
        )}&response_type=token&scope=user.info.basic&state=tiktok`;
        window.location.href = url;
      };

      const userTracksRaw = await fetchUserTracks(MRFLEN_AUDIUS_HANDLE);
      const userTracks = userTracksRaw.map(normalizeAudiusTrack);
      const remixes = userTracksRaw
        .filter((t) => t.remix_of)
        .map(normalizeAudiusTrack);
      refengineeredList.innerHTML = renderTracksList(remixes, true);

      function renderNewReleases() {
        const tracks = window.sortTracks(userTracks.slice(), 'latest');
        newReleasesList.innerHTML = renderTracksList(tracks, true);
      }

      function populateMonthSelect() {
        const months = window.listMonths(userTracks);
        monthSelect.innerHTML = '<option value="">Select month</option>';
        months.forEach((m) => {
          const opt = document.createElement('option');
          opt.value = m;
          opt.textContent = m;
          monthSelect.appendChild(opt);
        });
      }

      monthSelect.addEventListener('change', (e) => {
        const m = e.target.value;
        if (m) window.location.href = `releases.html?month=${m}`;
      });

      renderNewReleases();
      populateMonthSelect();

      performSearch(MRFLEN_AUDIUS_HANDLE);

      // ‚åò/Ctrl-K to focus
      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
          e.preventDefault();
          search.focus();
        } else if (e.code === "Space" && e.target === document.body && audioPlayer) {
          e.preventDefault();
          audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
        }
      });
      shuffleBtn.onclick = () => {
        if (queue.length) {
          currentIndex = Math.floor(Math.random() * queue.length);
          playTrack(queue[currentIndex]);
        }
      };

      // Google Drive backup and restore
      function initDriveBackup() {
        if (!window.DriveBackup || !window.GOOGLE_CLIENT_ID) return;
        (function poll() {
          if (window.google) {
            DriveBackup.init(window.GOOGLE_CLIENT_ID);
          } else {
            setTimeout(poll, 100);
          }
        })();
      }
      initDriveBackup();
      const backupBtn = document.getElementById("backup-btn");
      const restoreBtn = document.getElementById("restore-btn");
      function showBackup() {
        backupBtn.style.display = "inline-block";
      }
      const originalSetItem = localStorage.setItem.bind(localStorage);
      localStorage.setItem = (k, v) => {
        originalSetItem(k, v);
        showBackup();
      };
      backupBtn.onclick = async () => {
        try {
          await DriveBackup.upload({ localStorage: { ...localStorage } });
          backupBtn.style.display = "none";
          alert("Backup complete");
        } catch (err) {
          console.error(err);
          alert("Backup failed");
        }
      };
      restoreBtn.onclick = async () => {
        try {
          const data = await DriveBackup.download();
          if (data && data.localStorage) {
            for (const [k, v] of Object.entries(data.localStorage)) {
              originalSetItem(k, v);
            }
            alert("Restore complete");
          } else {
            alert("No backup found");
          }
        } catch (err) {
          console.error(err);
          alert("Restore failed");
        }
      };
    </script>
  </body>
</html>
