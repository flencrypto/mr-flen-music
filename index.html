<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mr.FLENs Music Finder ‚Äî Audius Library</title>
    <link
      rel="icon"
      href="https://audius-content-6.cultur3stake.com/content/01K0PYMD8X6ZA6JNCDWMWD4510/480x480.jpg"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <script>
      window.GOOGLE_CLIENT_ID = window.GOOGLE_CLIENT_ID || '';
    </script>
      <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;700&display=swap"
        rel="stylesheet"
      />
    <style>
      :root {
        /* Dark, futuristic palette inspired by the new dashboard mockup */
        --color-primary: #2f81f7;
        --color-secondary: #1f6feb;
        --color-bg: #0d1117;
        --color-glass: rgba(32, 38, 50, 0.6);
        --color-text: #f0f6fc;
        --color-muted: #8b949e;
      }
      body {
        background: var(--color-bg);
        color: var(--color-text);
        font-family: "Inter", sans-serif;
        margin: 0;
      }
      header,
      footer,
      main {
        max-width: 1100px;
        margin: auto;
      }
      .glass {
        backdrop-filter: saturate(1.2) blur(12px);
        background: var(--color-glass);
        border: 1px solid #ffffff11;
        border-radius: 16px;
        box-shadow: 0 0 20px #000;
      }
      .grid {
        display: grid;
        gap: 16px;
      }
      input#search {
        flex: 1;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid #ffffff22;
        background: #1c2333;
        color: var(--color-text);
        outline: none;
      }
      .track-card {
        display: grid;
        grid-template-columns: 72px 1fr auto auto;
        gap: 12px;
        padding: 12px;
        align-items: center;
      }
      .track-card img {
        border-radius: 10px;
      }
      .track-card .btn {
        opacity: 0;
        transition: opacity 0.2s;
      }
      .track-card:hover .btn {
        opacity: 1;
      }
      .btn {
        display: inline-block;
        text-decoration: none;
        border: 1px solid var(--color-primary);
        color: var(--color-text);
        padding: 8px 12px;
        border-radius: 10px;
        background: var(--color-primary);
        cursor: pointer;
      }
      .btn:hover {
        background: var(--color-secondary);
        border-color: var(--color-secondary);
      }
      .playlist-card {
        display: grid;
        grid-template-columns: 72px 1fr;
        gap: 12px;
        padding: 12px;
        align-items: center;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
      }
      .playlist-card img {
        border-radius: 10px;
      }
      .pill {
        padding: 2px 8px;
        border: 1px solid #ffffff22;
        border-radius: 999px;
        font-size: 12px;
        background: var(--color-glass);
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .chip {
        padding: 4px 10px;
        border: 1px solid var(--color-muted);
        border-radius: 20px;
        background: transparent;
        color: var(--color-muted);
        cursor: pointer;
      }
      .chip:hover {
        color: var(--color-secondary);
        border-color: var(--color-secondary);
      }
      .chip.active {
        background: var(--color-primary);
        color: #05060a;
        border-color: var(--color-primary);
      }
      .carousel {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 4px;
      }
      .featured img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 12px;
      }
      .logo {
        height: 40px;
        width: 40px;
        border-radius: 50%;
        border: 2px solid var(--color-secondary);
        box-shadow: 0 0 4px #000;
      }
      .modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.6);
      }
      .hidden {
        display: none;
      }
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
  </head>
  <body>
    <div id="fb-root"></div>
    <header class="glass grid" style="padding: 12px 16px; margin: 16px">
      <div
        class="row"
        style="justify-content: space-between; align-items: center"
      >
        <div class="row">
          <img
            src="https://audius-content-6.cultur3stake.com/content/01K0PYMD8X6ZA6JNCDWMWD4510/480x480.jpg"
            alt="Mr.FLEN logo"
            class="logo"
          />
          <h1 style="margin: 0">Mr.FLENs Music Finder</h1>
          <span class="pill">Audius+SC</span>
        </div>
        <button
          id="login"
          class="pill"
          style="cursor: pointer; background: #0000"
        >
          Login
        </button>
        <button id="backup-btn" class="pill" style="cursor:pointer;background:#0000;display:none;">Backup</button>
        <button id="restore-btn" class="pill" style="cursor:pointer;background:#0000;">Restore</button>
      </div>
      <div class="row" style="align-items: center; gap: 8px;">
        <input
          id="search"
          placeholder="Search tracks (Ctrl/‚åò-K)"
          autocomplete="off"
        />
        <label
          for="all-artists"
          style="display: flex; align-items: center; gap: 4px; font-size: 14px;"
        >
          <input type="checkbox" id="all-artists" /> Include all artists
        </label>
      </div>
      <div id="genres" class="row"></div>
    </header>

    <div id="login-modal" class="modal hidden">
      <div class="glass" style="padding:24px;max-width:320px;width:100%;">
        <h2>Sign in</h2>
        <div id="g_id_onload"
             data-client_id="GOOGLE_CLIENT_ID"
             data-context="signin"
             data-callback="onGoogleSignIn"></div>
        <div class="g_id_signin" data-type="standard" data-size="large"></div>
        <div id="fb-login-btn" class="btn" style="margin-top:8px;">Login with Facebook</div>
        <div id="insta-login-btn" class="btn" style="margin-top:8px;">Login with Instagram</div>
        <div id="x-login-btn" class="btn" style="margin-top:8px;">Login with X</div>
        <div id="snap-login-btn" class="btn" style="margin-top:8px;">Login with Snapchat</div>
        <div id="tiktok-login-btn" class="btn" style="margin-top:8px;">Login with TikTok</div>
        <div id="close-login" class="btn" style="margin-top:8px;background:transparent;border-color:var(--color-muted);color:var(--color-muted);">Close</div>
      </div>
    </div>

    <main id="results" class="grid" style="padding: 0 16px 140px"></main>

    <footer
      class="glass"
      style="
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 8px;
        margin: 16px;
        display: grid;
        gap: 8px;
      "
    >
      <div class="row" style="justify-content: space-between">
        <span id="queueLabel">Queue: 0</span>
        <div class="row" style="gap: 4px">
          <button id="shuffle" class="btn">üîÄ</button>
          <button id="next" class="btn">‚è≠</button>
        </div>
      </div>
      <div id="playerContainer">
        <audio id="player" controls preload="none" style="width: 100%"></audio>
      </div>
    </footer>
    <script src="public/drive.js"></script>
    <script type="module">
      /**
       * Audius REST integration for Mr.FLENs Music Finder.
       *
       * This script uses the public Audius API to search tracks and
       * obtain stream URLs. It debounces search input and updates
       * the result grid dynamically. To customise the look and feel,
       * edit the CSS in the <style> block above.
       */

      const AUDIUS_APP_NAME = "Mr.FLENs Music Finder";
      const AUDIUS_API_KEY = "922e6edcae9856000bf6814a1ee5745bfb57734"; // public, read-only (ok in client)
      const MRFLEN_AUDIUS_HANDLE = "Mr.FLEN";
      const MRFLEN_SC_USERNAME = "mr-flen";
      const SOUNDCLOUD_CLIENT_ID = "YOUR_SOUNDCLOUD_API_KEY";
      // BACKEND-ONLY (do NOT ship secrets to the browser):
      // const AUDIUS_API_SECRET = "YOUR_AUDIUS_API_SECRET";

      async function pickHost() {
        const res = await fetch("https://api.audius.co");
        const { data } = await res.json();
        return data[Math.floor(Math.random() * data.length)];
      }

      async function searchTracks(query) {
        const host = await pickHost();
        const url = `${host}/v1/tracks/search?query=${encodeURIComponent(query)}&app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
        const res = await fetch(url, {
          headers: { Accept: "application/json" },
        });
        const json = await res.json();
        return json.data || [];
      }

      async function searchSoundCloud(query, allArtists = false) {
        const url = `https://api.soundcloud.com/tracks?client_id=${SOUNDCLOUD_CLIENT_ID}&q=${encodeURIComponent(query)}&limit=20`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("sc");
        const json = await res.json();
        return allArtists
          ? json
          : json.filter((t) => t.user && t.user.username === MRFLEN_SC_USERNAME);
      }

      async function streamUrl(trackId) {
        const host = await pickHost();
        return `${host}/v1/tracks/${trackId}/stream?app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
      }

      async function trendingTracks(genre) {
        const host = await pickHost();
        const genreParam = genre ? `&genre=${encodeURIComponent(genre)}` : "";
        const url = `${host}/v1/tracks/trending?limit=5${genreParam}&app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
        const res = await fetch(url, {
          headers: { Accept: "application/json" },
        });
        const json = await res.json();
        return (json.data || []).map(normalizeAudiusTrack);
      }

      async function trendingPlaylists() {
        const host = await pickHost();
        const url = `${host}/v1/playlists/trending?limit=5&app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
        const res = await fetch(url, {
          headers: { Accept: "application/json" },
        });
        const json = await res.json();
        return json.data || [];
      }

      async function latestRelease() {
        const tracks = await searchTracks(MRFLEN_AUDIUS_HANDLE);
        return tracks[0] ? normalizeAudiusTrack(tracks[0]) : null;

        async function fetchPlaylist(id) {
          const host = await pickHost();
          const url = `${host}/v1/playlists/${id}?app_name=${encodeURIComponent(AUDIUS_APP_NAME)}&api_key=${encodeURIComponent(AUDIUS_API_KEY)}`;
          const res = await fetch(url, {
            headers: { Accept: "application/json" },
          });
          const json = await res.json();
          return json.data || null;
        }
      }

      function renderFeatured(track) {
        if (!track) return "";
        return `
    <a href="track.html?platform=${track.platform}&id=${track.id}" class="glass featured" style="display:block;text-decoration:none;color:inherit">
      <img src="${track.artwork}" alt="artwork" />
      <div style="padding:16px">
        <div style="font-weight:700">${track.title || ""}</div>
        <div style="opacity:.7">@${track.user.handle}</div>
      </div>
    </a>`;
      }

      function normalizeAudiusTrack(t) {
        return {
          platform: "audius",
          id: t.id,
          title: t.title,
          artwork:
            (t.artwork && (t.artwork["150x150"] || t.artwork["480x480"])) || "",
          user: { handle: t.user && t.user.handle ? t.user.handle : "" },
        };
      }

      function normalizeSoundCloudTrack(t) {
        return {
          platform: "soundcloud",
          id: t.id,
          title: t.title,
          artwork: t.artwork_url || "",
          permalink_url: t.permalink_url,
          user: { handle: t.user && t.user.username ? t.user.username : "" },
        };
      }

      const LIKED_KEY = 'likedTracks';
      const PLAYLIST_KEY = 'customPlaylists';

      let likedTracks = [];
      let customPlaylists = [];

      function loadPreferences() {
        try {
          return {
            liked: JSON.parse(localStorage.getItem(LIKED_KEY)) || [],
            playlists: JSON.parse(localStorage.getItem(PLAYLIST_KEY)) || [],
          };
        } catch {
          return { liked: [], playlists: [] };
        }
      }

      function savePreferences() {
        try {
          localStorage.setItem(LIKED_KEY, JSON.stringify(likedTracks));
          localStorage.setItem(
            PLAYLIST_KEY,
            JSON.stringify(customPlaylists)
          );
        } catch {
          // Ignore storage write errors
        }
      }

      function isLiked(track) {
        return likedTracks.some(
          (t) => t.id === track.id && t.platform === track.platform
        );
      }

      function toggleLike(track) {
        if (isLiked(track)) {
          likedTracks = likedTracks.filter(
            (t) => !(t.id === track.id && t.platform === track.platform)
          );
        } else {
          likedTracks.push(track);
        }
        savePreferences();
      }

      function savePlaylist(pl) {
        const idx = customPlaylists.findIndex((p) => p.name === pl.name);
        if (idx > -1) customPlaylists[idx] = pl;
        else customPlaylists.push(pl);
        savePreferences();
      }

      ({ liked: likedTracks, playlists: customPlaylists } = loadPreferences());

      /** UI wiring **/

      const results = document.querySelector("#results");
      let audioPlayer = document.querySelector("#player");
      const search = document.querySelector("#search");
      const allArtistsToggle = document.querySelector("#all-artists");
      const login = document.querySelector("#login");
      const loginModal = document.querySelector("#login-modal");
      const fbLoginBtn = document.querySelector("#fb-login-btn");
      const instaLoginBtn = document.querySelector("#insta-login-btn");
      const xLoginBtn = document.querySelector("#x-login-btn");
      const snapLoginBtn = document.querySelector("#snap-login-btn");
      const tiktokLoginBtn = document.querySelector("#tiktok-login-btn");
      const closeLogin = document.querySelector("#close-login");
      const nextBtn = document.querySelector("#next");
      const shuffleBtn = document.querySelector("#shuffle");
      const queueLabel = document.querySelector("#queueLabel");
      const genresEl = document.querySelector("#genres");
      allArtistsToggle.checked =
        localStorage.getItem("searchAllArtists") === "true";
      allArtistsToggle.addEventListener("change", () => {
        localStorage.setItem(
          "searchAllArtists",
          allArtistsToggle.checked ? "true" : "false"
        );
        const q = search.value.trim();
        if (q) search.dispatchEvent(new Event("input"));
      });
      const { handleAuthSuccess } = window;
      const GENRES = ["All", "UKG", "Grime", "House", "DNB"];
      let currentGenre = null;
      if (window.location.hash.includes("access_token")) {
        const params = new URLSearchParams(window.location.hash.substring(1));
        const token = params.get("access_token");
        const provider = params.get("state");
        if (token && provider) handleAuthSuccess(provider, token);
        window.location.hash = "";
      }
      GENRES.forEach((g) => {
        const chip = document.createElement("button");
        chip.textContent = g;
        chip.className = "chip" + (g === "All" ? " active" : "");
        chip.onclick = () => {
          currentGenre = g === "All" ? null : g;
          Array.from(genresEl.children).forEach((c) =>
            c.classList.remove("active"),
          );
          chip.classList.add("active");
          loadHome(currentGenre);
        };
        genresEl.appendChild(chip);
      });

      const trackCache = {};
      const queue = [];
      let currentIndex = -1;

      function updateQueue() {
        queueLabel.textContent = `Queue: ${queue.length}`;
      }

      async function playTrack(track) {
        const container = document.querySelector("#playerContainer");
        if (track.platform === "soundcloud") {
          const res = await fetch(
            `https://soundcloud.com/oembed?format=json&url=${encodeURIComponent(track.permalink_url)}`,
          );
          const { html } = await res.json();
          container.innerHTML = html;
          audioPlayer = null;
        } else {
          container.innerHTML =
            '<audio id="player" controls preload="none" style="width:100%"></audio>';
          audioPlayer = document.querySelector("#player");
          const url = await streamUrl(track.id);
          audioPlayer.src = url;
          await audioPlayer.play();
          audioPlayer.addEventListener("ended", () => nextBtn.onclick(), {
            once: true,
          });
        }
      }

      function renderTracksList(list, includeLink = false) {
        return list
          .map((t) => {
            trackCache[`${t.platform}:${t.id}`] = t;
            const buttons = [
              `<button data-platform="${t.platform}" data-id="${t.id}" class="btn play">‚ñ∂</button>`,
            ];
            if (t.platform === "audius")
              buttons.push(
                `<button data-platform="${t.platform}" data-id="${t.id}" class="btn queue">‚ûï</button>`,
              );
            buttons.push(
              `<button data-platform="${t.platform}" data-id="${t.id}" class="btn like">${isLiked(t) ? "‚ô•" : "‚ô°"}</button>`,
            );
            if (includeLink)
              buttons.push(
                `<a href="track.html?platform=${t.platform}&id=${t.id}" class="btn">Go To Track</a>`,
              );
            const cols = `72px 1fr${" auto".repeat(buttons.length)}`;
            const badge = `<span class="pill">${t.platform === "audius" ? "Audius" : "SoundCloud"}</span>`;
            return `
      <div class="glass track-card" style="grid-template-columns:${cols};">
        <img src="${t.artwork}" width="72" height="72" loading="lazy" alt="artwork" />
        <div>
          <div style="font-weight:700">${t.title || ""}</div>
          <div style="opacity:.7">@${t.user.handle} ${badge}</div>
        </div>
        ${buttons.join("")}
      </div>`;
          })
          .join("");
      }

      function attachTrackEvents(container = results) {
        container.querySelectorAll(".play").forEach((btn) => {
          btn.onclick = async () => {
            const key = `${btn.dataset.platform}:${btn.dataset.id}`;
            const track = trackCache[key];
            if (track.platform === "audius") {
              queue.push(track);
              currentIndex = queue.length - 1;
              updateQueue();
            }
            await playTrack(track);
          };
        });
        container.querySelectorAll(".queue").forEach((btn) => {
          btn.onclick = () => {
            const key = `${btn.dataset.platform}:${btn.dataset.id}`;
            const track = trackCache[key];
            queue.push(track);
            updateQueue();
          };
        });
        container.querySelectorAll(".like").forEach((btn) => {
          btn.onclick = () => {
            const key = `${btn.dataset.platform}:${btn.dataset.id}`;
            const track = trackCache[key];
            toggleLike(track);
            btn.textContent = isLiked(track) ? "‚ô•" : "‚ô°";
          };
        });
      }

      function renderPlaylistList(list) {
        return list
          .map((p) => {
            const art =
              (p.artwork && (p.artwork["150x150"] || p.artwork["480x480"])) ||
              "";
            return `
      <a class="glass playlist-card" href="playlist.html?id=${p.id}">
        <img src="${art}" width="72" height="72" loading="lazy" alt="artwork" />
        <div>
          <div style="font-weight:700">${p.playlist_name || ""}</div>
          <div style="opacity:.7">${p.track_count || 0} tracks</div>
        </div>
      </a>`;
          })
          .join("");
      }

      async function loadHome(genre) {
        results.innerHTML =
          '<div class="glass" style="padding:16px;">Loading‚Ä¶</div>';
        try {
          const [tracks, playlists, feature] = await Promise.all([
            trendingTracks(genre),
            trendingPlaylists(),
            latestRelease(),
          ]);
          const genreLabel = genre ? ` ‚Äî ${genre}` : "";
          results.innerHTML = `
      ${renderFeatured(feature)}
      <h2>Trending Tracks${genreLabel}</h2>
      <div class="carousel">${renderTracksList(tracks, true)}</div>
      <h2>Trending Playlists</h2>
      ${renderPlaylistList(playlists)}
    `;
          attachTrackEvents();
        } catch (err) {
          console.error(err);
          results.innerHTML =
            '<div class="glass" style="padding:16px;">Error loading trending data.</div>';
        }
      }

      let debounceTimer = null;
      search.addEventListener("input", async (e) => {
        const q = e.target.value.trim();
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
          if (!q) {
            loadHome(currentGenre);
            return;
          }
          results.innerHTML =
            '<div class="glass" style="padding:16px;">Searching‚Ä¶</div>';
          try {
            let scError = false;
            const allArtists = allArtistsToggle.checked;
            const [a, s] = await Promise.all([
              searchTracks(q),
              searchSoundCloud(q, allArtists).catch(() => {
                scError = true;
                return [];
              }),
            ]);
            const audiusTracks = allArtists
              ? a
              : a.filter((t) => t.user && t.user.handle === MRFLEN_AUDIUS_HANDLE);
            const tracks = [
              ...audiusTracks.map(normalizeAudiusTrack),
              ...s.map(normalizeSoundCloudTrack),
            ];
            const scopeText = allArtists
              ? "Showing all artists"
              : "Showing Mr.FLEN only";
            if (!tracks.length) {
              let html =
                '<div class="glass" style="padding:16px;">No tracks found.</div>';
              if (scError)
                html +=
                  '<div class="glass" style="padding:16px;margin-top:8px;">‚ö†Ô∏è SoundCloud results unavailable.</div>';
              html +=
                `<div class="glass" style="padding:16px;margin-top:8px;">${scopeText}</div>`;
              results.innerHTML = html;
              return;
            }
            tracks.sort((a, b) => a.title.localeCompare(b.title));
            let html =
              `<div class="glass" style="padding:16px;margin-bottom:8px;">${scopeText}</div>` +
              renderTracksList(tracks, true);
            if (scError)
              html =
                '<div class="glass" style="padding:16px;">‚ö†Ô∏è SoundCloud results unavailable.</div>' +
                html;
            results.innerHTML = html;
            attachTrackEvents();
          } catch (err) {
            console.error(err);
            results.innerHTML =
              '<div class="glass" style="padding:16px;">Error contacting APIs.</div>';
          }
        }, 250);
      });

      nextBtn.onclick = () => {
        if (currentIndex + 1 < queue.length) {
          currentIndex++;
          playTrack(queue[currentIndex]);
        }
      };

      login.onclick = () => loginModal.classList.remove("hidden");
      closeLogin.onclick = () => loginModal.classList.add("hidden");
      window.onGoogleSignIn = (res) => {
        handleAuthSuccess("google", res.credential);
      };
      window.fbAsyncInit = function () {
        FB.init({
          appId: "FACEBOOK_APP_ID",
          cookie: true,
          xfbml: true,
          version: "v19.0",
        });
      };
      fbLoginBtn.onclick = () => {
        FB.login(
          (response) => {
            if (response.authResponse) {
              handleAuthSuccess("facebook", response.authResponse.accessToken);
            }
          },
          { scope: "public_profile,email" }
        );
      };
      const buildRedirectUri = () =>
        window.location.origin +
        window.location.pathname +
        window.location.search;
      instaLoginBtn.onclick = () => {
        const clientId = process?.env?.INSTAGRAM_CLIENT_ID;
        const redirectUri = buildRedirectUri();
        const url = `https://api.instagram.com/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(
          redirectUri
        )}&scope=user_profile&response_type=token&state=instagram`;
        window.location.href = url;
      };
      xLoginBtn.onclick = () => {
        const clientId = process?.env?.X_CLIENT_ID;
        const redirectUri = buildRedirectUri();
        const url = `https://twitter.com/i/oauth2/authorize?response_type=token&client_id=${clientId}&redirect_uri=${encodeURIComponent(
          redirectUri
        )}&scope=tweet.read%20users.read&state=x`;
        window.location.href = url;
      };
      snapLoginBtn.onclick = () => {
        const clientId = process?.env?.SNAPCHAT_CLIENT_ID;
        const redirectUri = buildRedirectUri();
        const url = `https://accounts.snapchat.com/accounts/oauth2/auth?response_type=token&client_id=${clientId}&redirect_uri=${encodeURIComponent(
          redirectUri
        )}&scope=snapchat_marketing_api&state=snapchat`;
        window.location.href = url;
      };
      tiktokLoginBtn.onclick = () => {
        const clientId = process?.env?.TIKTOK_CLIENT_ID;
        const redirectUri = buildRedirectUri();
        const url = `https://www.tiktok.com/auth/authorize?client_key=${clientId}&redirect_uri=${encodeURIComponent(
          redirectUri
        )}&response_type=token&scope=user.info.basic&state=tiktok`;
        window.location.href = url;
      };

      loadHome(currentGenre);

      // ‚åò/Ctrl-K to focus
      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
          e.preventDefault();
          search.focus();
        }
      });
      shuffleBtn.onclick = () => {
        if (queue.length) {
          currentIndex = Math.floor(Math.random() * queue.length);
          playTrack(queue[currentIndex]);
        }
      };

      // Google Drive backup and restore
      function initDriveBackup() {
        if (!window.DriveBackup || !window.GOOGLE_CLIENT_ID) return;
        (function poll() {
          if (window.google) {
            DriveBackup.init(window.GOOGLE_CLIENT_ID);
          } else {
            setTimeout(poll, 100);
          }
        })();
      }
      initDriveBackup();
      const backupBtn = document.getElementById("backup-btn");
      const restoreBtn = document.getElementById("restore-btn");
      function showBackup() {
        backupBtn.style.display = "inline-block";
      }
      const originalSetItem = localStorage.setItem.bind(localStorage);
      localStorage.setItem = (k, v) => {
        originalSetItem(k, v);
        showBackup();
      };
      backupBtn.onclick = async () => {
        try {
          await DriveBackup.upload({ localStorage: { ...localStorage } });
          backupBtn.style.display = "none";
          alert("Backup complete");
        } catch (err) {
          console.error(err);
          alert("Backup failed");
        }
      };
      restoreBtn.onclick = async () => {
        try {
          const data = await DriveBackup.download();
          if (data && data.localStorage) {
            for (const [k, v] of Object.entries(data.localStorage)) {
              originalSetItem(k, v);
            }
            alert("Restore complete");
          } else {
            alert("No backup found");
          }
        } catch (err) {
          console.error(err);
          alert("Restore failed");
        }
      };
    </script>
  </body>
</html>
